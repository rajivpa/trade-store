name: Deployment Pipeline - Trade Processor

on:
  workflow_dispatch:
  push:
    branches:
      - main
      - master
    paths:
      - ".github/workflows/deployment-pipeline.yml"
      - "services/trade-processor/**"
  pull_request:
    branches:
      - main
      - master
    paths:
      - ".github/workflows/deployment-pipeline.yml"
      - "services/trade-processor/**"

permissions:
  contents: read

jobs:
  build:
    name: Build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "21"
          cache: maven
          cache-dependency-path: services/trade-processor/pom.xml

      - name: Build
        working-directory: services/trade-processor
        run: |
          chmod +x mvnw
          ./mvnw -B -ntp clean compile -DskipTests

  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "21"
          cache: maven
          cache-dependency-path: services/trade-processor/pom.xml

      - name: Run unit tests
        working-directory: services/trade-processor
        run: |
          chmod +x mvnw
          ./mvnw -B -ntp test -Dtest='*Test'

  regression-tests:
    name: Regression Tests
    runs-on: ubuntu-latest
    needs: unit-tests
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "21"
          cache: maven
          cache-dependency-path: services/trade-processor/pom.xml

      - name: Run regression tests
        working-directory: services/trade-processor
        run: |
          chmod +x mvnw
          ./mvnw -B -ntp test

  oss-vulnerability-scan:
    name: OSS Vulnerability Scan
    runs-on: ubuntu-latest
    needs: regression-tests
    timeout-minutes: 30
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "21"
          cache: maven
          cache-dependency-path: services/trade-processor/pom.xml

      - name: Run dependency vulnerability scan
        working-directory: services/trade-processor
        env:
          NVD_API_KEY: ${{ secrets.NVD_API_KEY }}
        run: |
          chmod +x mvnw
          for attempt in 1 2 3; do
            ./mvnw -B -ntp org.owasp:dependency-check-maven:check \
              -Dformat=HTML \
              -DfailBuildOnCVSS=9.0 \
              -DnvdApiKey="${NVD_API_KEY}" \
              -DossindexAnalyzerEnabled=false \
              -DossIndexWarnOnlyOnRemoteErrors=true && break
            if [ "$attempt" -eq 3 ]; then
              echo "Dependency scan failed after 3 attempts"
              exit 1
            fi
            echo "Dependency scan failed on attempt $attempt, retrying in 30s..."
            sleep 30
          done

      - name: Upload vulnerability report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: dependency-check-report
          path: services/trade-processor/target/dependency-check-report.html
          if-no-files-found: ignore

  deploy:
    name: Deploy
    runs-on: ubuntu-latest
    needs:
      - build
      - unit-tests
      - regression-tests
      - oss-vulnerability-scan
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "21"
          cache: maven
          cache-dependency-path: services/trade-processor/pom.xml

      - name: Build deployable artifact
        working-directory: services/trade-processor
        run: |
          chmod +x mvnw
          ./mvnw -B -ntp package -DskipTests

      - name: Upload deployment artifact
        uses: actions/upload-artifact@v4
        with:
          name: trade-processor-jar
          path: services/trade-processor/target/*.jar
